name: Vessel Monitor (Safi-Nador-Jorf)

on:
  schedule:
    - cron: '*/30 * * * *'       # Every 30 minutes for tracking
    - cron: '0 8 1 * *'          # Monthly report on the 1st at 08:00
  workflow_dispatch:             # Manual run button

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write            # Critical for saving state.json
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install Dependencies
        run: pip install requests

      - name: ğŸš€ Run Script
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_ENABLED: "true"
          RUN_MODE: ${{ github.event.schedule == '0 8 1 * *' && 'report' || 'monitor' }}
        run: |
          echo "Executing in MODE: $RUN_MODE"
          python monitor.py

      - name: ğŸ’¾ Commit and Push State
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git add state.json
          
          # Only commit if state.json actually changed
          if git diff --staged --quiet; then
            echo "âœ… No changes to state.json"
          else
            if [[ "${{ env.RUN_MODE }}" == "report" ]]; then
              git commit -m "ğŸ“Š Monthly report generated [skip ci]"
            else
              git commit -m "ğŸ¤– Vessel state update [skip ci]"
            fi
            git push
            echo "âœ… State committed"
          fi
